{{ $showDrafts := $.Site.Params.showDraftCourses }}
{{ $totalVisibleCourses := 0 }}

{{ range .Site.Data.courses.courseLevels }}
  {{ $levelId := .id }}
  {{ $levelTitle := .title }}
  {{ $levelIcon := .icon }}
  {{ $levelAccent := .accent }}
  {{ $coursesInLevel := where $.Site.Data.courses.courses "level" $levelId }}
  {{ $visibleCoursesInLevel := 0 }}
  
<div class="course-level courses-left-align" data-accent="{{ $levelAccent }}" data-level="{{ $levelId }}">
  <h2 class="level-title">{{ $levelIcon }} {{ $levelTitle }}</h2>
  <div class="course-grid{{ if eq $levelId "research" }} research{{ end }}">
    {{ range $coursesInLevel }}
    {{ if or (not .draft) $showDrafts }}
    {{ $visibleCoursesInLevel = add $visibleCoursesInLevel 1 }}
    {{ $totalVisibleCourses = add $totalVisibleCourses 1 }}
    {{ $fieldInfo := (index (where $.Site.Data.courses.courseFields "id" .field) 0) }}
    {{ $coursePagePath := printf "/courses/%s/" .shortcode }}
    {{ $coursePage := $.Site.GetPage $coursePagePath }}
    {{ $hasDetailPage := ne $coursePage nil }}
    
    {{ if $hasDetailPage }}
    <a href="{{ $coursePagePath }}" class="course-card-link" data-level="{{ $levelId }}" data-field="{{ .field }}">
    {{ end }}
    <div class="course-card{{ if $hasDetailPage }} has-link{{ end }}" data-level="{{ $levelId }}" data-field="{{ .field }}">
      {{ if .new }}
      <div class="course-new-ribbon" style="background-color: {{ $fieldInfo.color }}">
        <span class="ribbon-text">New</span>
      </div>
      {{ end }}
      <h3>{{ .title }}</h3>
      <p>{{ .description }}</p>
      {{ if or .shortcode .duration .price }}
      <div class="course-meta">
        {{ if .shortcode }}<span class="course-shortcode">{{ .shortcode }}</span>{{ end }}
        {{ if .duration }}<span class="course-duration">{{ .duration }}w</span>{{ end }}
        {{ if .price }}<span class="course-price">${{ .price }}/ppw</span>{{ end }}
      </div>
      {{ end }}
      <div class="course-field-stripe" style="background-color: {{ $fieldInfo.color }}">
        <span class="field-name">{{ $fieldInfo.title }}</span>
      </div>
    </div>
    {{ if $hasDetailPage }}
    </a>
    {{ end }}
    {{ end }}
    {{ end }}
    {{ if eq $visibleCoursesInLevel 0 }}
    <p class="no-courses-message">No courses available at this level yet.</p>
    {{ end }}
  </div>
</div>
{{ end }}

{{ if eq $totalVisibleCourses 0 }}
<div class="no-courses-global-message courses-left-align">
  <p>No courses are currently available. Please check back later or <a href="/contact/">contact us</a> for custom training options.</p>
</div>
{{ end }}